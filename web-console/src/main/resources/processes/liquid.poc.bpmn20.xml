<?xml version="1.0" encoding="UTF-8" ?>

<definitions id="definitions"
             targetNamespace="http://activiti.org/bpmn20"
             xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:activiti="http://activiti.org/bpmn">

    <process id="liquidPoc" name="Liquid POC">

        <startEvent id="placeOrder" activiti:initiator="employeeName">
            <extensionElements>
                <activiti:formProperty id="customer" name="Customer" type="string" required="true"/>
            </extensionElements>
        </startEvent>
        <sequenceFlow id="flow0" sourceRef="placeOrder" targetRef="planRoute"/>

        <userTask id="planRoute" name="路线规划">
            <documentation>
                ${employeeName}已经下订单。您需要制定运输路线方案。
            </documentation>
            <extensionElements>
                <activiti:formProperty id="route" name="Route" type="string" required="true"/>
            </extensionElements>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_MARKETING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow10" sourceRef="planRoute" targetRef="planLoading"/>

        <userTask id="planLoading" name="制定装载方案">
            <documentation>
                ${employeeName}已经制定运输路线方案。您需要制定装载方案。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow20" sourceRef="planLoading" targetRef="allocateContainers"/>

        <userTask id="allocateContainers" name="分配集装箱">
            <documentation>
                ${employeeName}已经制定制定装载方案。您需要分配集装箱。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_CONTAINER</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow30" sourceRef="allocateContainers" targetRef="loadingDecision"/>

        <exclusiveGateway id="loadingDecision" name="装货决策"/>
        <sequenceFlow id="flow40" sourceRef="loadingDecision" targetRef="sendLoadingOnYard">
            <conditionExpression xsi:type="tFormalExpression">${loadingType == 0}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow50" sourceRef="loadingDecision" targetRef="sendLoadingByTruck">
            <conditionExpression xsi:type="tFormalExpression">${loadingType == 1}</conditionExpression>
        </sequenceFlow>

        <userTask id="sendLoadingOnYard" name="发布场装指令">
            <documentation>
                ${employeeName}已经分配集装箱。您需要发布场装指令。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow60" sourceRef="sendLoadingOnYard" targetRef="loadOnYardAndRailwayPlanFork"/>

        <userTask id="sendLoadingByTruck" name="发布外拖指令">
            <documentation>
                ${employeeName}已经分配集装箱。您需要发布场装指令。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow70" sourceRef="sendLoadingByTruck" targetRef="loadByTruckAndRailwayPlanFork"/>

        <parallelGateway id="loadOnYardAndRailwayPlanFork" name="场装同时申报铁路计划"/>
        <sequenceFlow id="flow80" sourceRef="loadOnYardAndRailwayPlanFork" targetRef="applyRailwayPlan"/>
        <sequenceFlow id="flow90" sourceRef="loadOnYardAndRailwayPlanFork" targetRef="loadOnYard"/>

        <parallelGateway id="loadByTruckAndRailwayPlanFork" name="外拖同时申报铁路计划"/>
        <sequenceFlow id="flow100" sourceRef="loadByTruckAndRailwayPlanFork" targetRef="applyRailwayPlan"/>
        <sequenceFlow id="flow110" sourceRef="loadByTruckAndRailwayPlanFork" targetRef="loadByTruck"/>

        <userTask id="loadOnYard" name="场装作业">
            <documentation>
                ${employeeName}已经发布场装指令。您需要进行场装作业。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_FIELD</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow120" sourceRef="loadOnYard" targetRef="recordTod"/>

        <userTask id="loadByTruck" name="外拖作业">
            <documentation>
                ${employeeName}已经发布外拖指令。您需要进行外拖作业。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_FIELD</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow130" sourceRef="loadByTruck" targetRef="recordTod"/>

        <userTask id="applyRailwayPlan" name="申报铁路计划">
            <documentation>
                ${employeeName}已经发布外拖指令。您需要进行外拖作业。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow140" sourceRef="loadByTruck" targetRef="loadAndRailwayPlanJoin"/>

        <!-- record time of dispatch -->
        <userTask id="recordTod" name="记录装车发运时间">
            <documentation>
                ${employeeName}已经发布外拖指令。您需要进行外拖作业。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_FIELD</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow150" sourceRef="loadByTruck" targetRef="loadAndRailwayPlanJoin"/>

        <parallelGateway id="loadAndRailwayPlanJoin" name="装货发车同时申报铁路计划合并"/>
        <sequenceFlow id="flow160" sourceRef="loadAndRailwayPlanJoin" targetRef="theEnd1"/>

        <endEvent id="theEnd1"/>

    </process>

</definitions>