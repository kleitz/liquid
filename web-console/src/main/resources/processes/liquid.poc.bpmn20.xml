<?xml version="1.0" encoding="UTF-8" ?>

<definitions id="definitions"
             targetNamespace="http://activiti.org/bpmn20"
             xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:activiti="http://activiti.org/bpmn">

    <process id="liquidPoc" name="Liquid POC">

        <extensionElements>
            <activiti:executionListener event="end" class="liquid.task.handler.ProcessEndHandler"/>
        </extensionElements>

        <startEvent id="placeOrder" activiti:initiator="employeeName"/>
        <sequenceFlow id="flow0" sourceRef="placeOrder" targetRef="feedDistyPrice"/>

        <userTask id="feedDistyPrice" name="填写渠道价格">
            <documentation>
                ${employeeName}已经下订单。您需要填写渠道价格。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_MARKETING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow10" sourceRef="feedDistyPrice" targetRef="planRoute"/>

        <userTask id="planRoute" name="路线规划">
            <documentation>
                ${employeeName}已经填写渠道价格。您需要制定运输路线方案。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_MARKETING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow20" sourceRef="planRoute" targetRef="planLoading"/>

        <userTask id="planLoading" name="制定装载方案">
            <documentation>
                ${employeeName}已经制定运输路线方案。您需要制定装载方案。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow30" sourceRef="planLoading" targetRef="allocateContainers"/>

        <userTask id="allocateContainers" name="分配集装箱">
            <documentation>
                ${employeeName}已经制定制定装载方案。您需要分配集装箱。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_CONTAINER</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow40" sourceRef="allocateContainers" targetRef="loadingDecision"/>

        <exclusiveGateway id="loadingDecision" name="装货决策"/>
        <sequenceFlow id="flow50" sourceRef="loadingDecision" targetRef="sendLoadingOnYard">
            <conditionExpression xsi:type="tFormalExpression">${loadingType == 0}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow60" sourceRef="loadingDecision" targetRef="sendLoadingByTruck">
            <conditionExpression xsi:type="tFormalExpression">${loadingType == 1}</conditionExpression>
        </sequenceFlow>

        <userTask id="sendLoadingOnYard" name="发布场装指令">
            <documentation>
                ${employeeName}已经分配集装箱。您需要发布场装指令。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow70" sourceRef="sendLoadingOnYard" targetRef="loadOnYardAndRailwayPlanFork"/>

        <userTask id="sendLoadingByTruck" name="发布外拖指令">
            <documentation>
                ${employeeName}已经分配集装箱。您需要发布外拖指令。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow80" sourceRef="sendLoadingByTruck" targetRef="loadByTruckAndRailwayPlanFork"/>

        <parallelGateway id="loadOnYardAndRailwayPlanFork" name="场装同时申报铁路计划"/>
        <sequenceFlow id="flow90" sourceRef="loadOnYardAndRailwayPlanFork" targetRef="applyRailwayPlan"/>
        <sequenceFlow id="flow1000" sourceRef="loadOnYardAndRailwayPlanFork" targetRef="loadOnYard"/>

        <parallelGateway id="loadByTruckAndRailwayPlanFork" name="外拖同时申报铁路计划"/>
        <sequenceFlow id="flow110" sourceRef="loadByTruckAndRailwayPlanFork" targetRef="applyRailwayPlan"/>
        <sequenceFlow id="flow120" sourceRef="loadByTruckAndRailwayPlanFork" targetRef="sendingTruckDecision"/>

        <userTask id="loadOnYard" name="场装作业">
            <documentation>
                ${employeeName}已经发布场装指令。您需要进行场装作业。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_FIELD</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow130" sourceRef="loadOnYard" targetRef="recordTory"/>

        <exclusiveGateway id="sendingTruckDecision" name="派车决策"/>
        <sequenceFlow id="flow140" sourceRef="sendingTruckDecision" targetRef="salesSendingTruck">
            <conditionExpression xsi:type="tFormalExpression">${truckingRole == 'SALES'}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow150" sourceRef="sendingTruckDecision" targetRef="marketingSendingTruck">
            <conditionExpression xsi:type="tFormalExpression">${truckingRole == 'MARKETING'}</conditionExpression>
        </sequenceFlow>

        <userTask id="salesSendingTruck" name="销售派车">
            <documentation>
                ${employeeName}已经发布外拖指令。您需要派车。
            </documentation>
            <extensionElements>
                <activiti:taskListener event="create" delegateExpression="${truckingAssigneeHandler}"/>
            </extensionElements>
        </userTask>
        <sequenceFlow id="flow160" sourceRef="salesSendingTruck" targetRef="recordTory"/>

        <userTask id="marketingSendingTruck" name="市场派车">
            <documentation>
                ${employeeName}已经发布外拖指令。您需要派车。
            </documentation>
            <extensionElements>
                <activiti:taskListener event="create" delegateExpression="${truckingAssigneeHandler}"/>
            </extensionElements>
        </userTask>
        <sequenceFlow id="flow170" sourceRef="marketingSendingTruck" targetRef="loadByTruck"/>

        <userTask id="loadByTruck" name="外拖作业">
            <documentation>
                ${employeeName}已经发布外拖指令。您需要进行外拖作业。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_FIELD</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow180" sourceRef="loadByTruck" targetRef="recordTory"/>

        <userTask id="applyRailwayPlan" name="申报铁路计划">
            <documentation>
                ${employeeName}已经发布外拖指令。您需要申报铁路计划。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow190" sourceRef="applyRailwayPlan" targetRef="loadAndRailwayPlanJoin"/>

        <!-- record time of dispatch -->
        <userTask id="recordTory" name="记录进入铁路货场时间">
            <documentation>
                ${employeeName}已经发布外拖指令。您需要记录进入铁路货场时间。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_FIELD</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow200" sourceRef="recordTory" targetRef="loadAndRailwayPlanJoin"/>

        <parallelGateway id="loadAndRailwayPlanJoin" name="装货发车同时申报铁路计划合并"/>
        <sequenceFlow id="flow210" sourceRef="loadAndRailwayPlanJoin" targetRef="recordTod"/>

        <!-- record time of dispatch -->
        <userTask id="recordTod" name="记录装车发运时间">
            <documentation>
                ${employeeName}已经记录进入铁路货场时间。您需要记录装车发运时间。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_FIELD</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow220" sourceRef="recordTod" targetRef="bargeOpsDecision"/>

        <exclusiveGateway id="bargeOpsDecision" name="驳船操作决策"/>
        <sequenceFlow id="flow260" sourceRef="bargeOpsDecision" targetRef="doBargeOps">
            <conditionExpression xsi:type="tFormalExpression">${hasBarge == true}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow270" sourceRef="bargeOpsDecision" targetRef="vesselOpsDecision">
            <conditionExpression xsi:type="tFormalExpression">${hasBarge == false}</conditionExpression>
        </sequenceFlow>

        <userTask id="doBargeOps" name="驳船操作">
            <documentation>
                铁路已经发车。您需要驳船操作。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow280" sourceRef="doBargeOps" targetRef="vesselOpsDecision"/>

        <exclusiveGateway id="vesselOpsDecision" name="大船操作决策"/>
        <sequenceFlow id="flow310" sourceRef="vesselOpsDecision" targetRef="doVesselOps">
            <conditionExpression xsi:type="tFormalExpression">${hasVessel == true}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow320" sourceRef="vesselOpsDecision" targetRef="deliveryDecision">
            <conditionExpression xsi:type="tFormalExpression">${hasVessel == false}</conditionExpression>
        </sequenceFlow>

        <userTask id="doVesselOps" name="大船操作">
            <documentation>
                您需要大船操作。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow330" sourceRef="doVesselOps" targetRef="deliveryDecision"/>

        <exclusiveGateway id="deliveryDecision" name="配送决策"/>
        <sequenceFlow id="flow340" sourceRef="deliveryDecision" targetRef="deliver">
            <conditionExpression xsi:type="tFormalExpression">${hasDelivery == true}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow350" sourceRef="deliveryDecision" targetRef="reclaimReceipt">
            <conditionExpression xsi:type="tFormalExpression">${hasDelivery == false}</conditionExpression>
        </sequenceFlow>

        <userTask id="deliver" name="配送">
            <documentation>
                货物已经到达，您需要配送。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow360" sourceRef="deliver" targetRef="reclaimReceipt"/>

        <userTask id="reclaimReceipt" name="回收签收单">
            <documentation>
                货物已经到达，您需要回收签收单。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow370" sourceRef="reclaimReceipt" targetRef="adjustPrice"/>

        <userTask id="adjustPrice" name="修正订单价格">
            <documentation>
                ${employeeName}回收签收单已经完成，您需要修正订单价格。
            </documentation>
            <!-- ROLE_SALES -->
            <humanPerformer>
                <resourceAssignmentExpression>
                    <formalExpression>${orderOwner}</formalExpression>
                </resourceAssignmentExpression>
            </humanPerformer>
        </userTask>
        <sequenceFlow id="flow380" sourceRef="adjustPrice" targetRef="sendInvoicingAndPsFork"/>

        <!-- ps means purchasing settlement -->
        <parallelGateway id="sendInvoicingAndPsFork" name=""/>
        <sequenceFlow id="flow390" sourceRef="sendInvoicingAndPsFork" targetRef="sendInvoicing"/>
        <sequenceFlow id="flow400" sourceRef="sendInvoicingAndPsFork" targetRef="sendSettling"/>

        <userTask id="sendInvoicing" name="发送开发票指令">
            <documentation>
                您需要发送开发票指令。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_COMMERCE</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow410" sourceRef="sendInvoicing" targetRef="confirmInvoiceAmount"/>

        <userTask id="confirmInvoiceAmount" name="确认发票金额">
            <documentation>
                您需要确认发票金额。
            </documentation>
            <!-- ROLE_SALES -->
            <humanPerformer>
                <resourceAssignmentExpression>
                    <formalExpression>${orderOwner}</formalExpression>
                </resourceAssignmentExpression>
            </humanPerformer>
        </userTask>
        <sequenceFlow id="flow420" sourceRef="confirmInvoiceAmount" targetRef="invoice"/>

        <userTask id="invoice" name="开发票">
            <documentation>
                您需要开发票。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_COMMERCE</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow430" sourceRef="invoice" targetRef="return"/>

        <userTask id="return" name="催收款">
            <documentation>
                您需要催收款。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_SALES</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow440" sourceRef="return" targetRef="confirmIncomeSettlement"/>

        <userTask id="confirmIncomeSettlement" name="确认收入结算">
            <documentation>
                您确认收入结算。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_COMMERCE</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow450" sourceRef="confirmIncomeSettlement" targetRef="settlementJoin"/>

        <userTask id="sendSettling" name="发送采购结算指令">
            <documentation>
                您需要发送采购结算指令。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_COMMERCE</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow460" sourceRef="sendSettling" targetRef="checkCostFork"/>

        <parallelGateway id="checkCostFork" name="市场操作同时核对金额"/>
        <sequenceFlow id="flow470" sourceRef="checkCostFork" targetRef="checkCostByMarketing"/>
        <sequenceFlow id="flow480" sourceRef="checkCostFork" targetRef="checkCostByOperating"/>

        <userTask id="checkCostByMarketing" name="核对金额">
            <documentation>
                您需要核对金额。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_MARKETING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow490" sourceRef="checkCostByMarketing" targetRef="confirmProviderInvoicingByMarketing"/>

        <userTask id="confirmProviderInvoicingByMarketing" name="确认供应商开具发票">
            <documentation>
                您需要确认供应商开具发票。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_MARKETING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow500" sourceRef="confirmProviderInvoicingByMarketing"
                      targetRef="checkFromMarketing"/>

        <userTask id="checkFromMarketing" name="核对市场采购金额">
            <documentation>
                您需要核对市场采购金额。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_COMMERCE</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow510" sourceRef="checkFromMarketing" targetRef="checkJoin"/>

        <userTask id="checkCostByOperating" name="核对金额">
            <documentation>
                您需要核对金额。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow520" sourceRef="checkCostByOperating" targetRef="confirmProviderInvoicingByOperating"/>

        <userTask id="confirmProviderInvoicingByOperating" name="确认供应商开具发票">
            <documentation>
                您需要确认供应商开具发票。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_OPERATING</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow530" sourceRef="confirmProviderInvoicingByOperating"
                      targetRef="checkFromOperating"/>

        <userTask id="checkFromOperating" name="核对操作采购金额">
            <documentation>
                您需要核对操作采购金额。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_COMMERCE</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow540" sourceRef="checkFromOperating" targetRef="checkJoin"/>

        <parallelGateway id="checkJoin" name="核对采购金额合并"/>
        <sequenceFlow id="flow550" sourceRef="checkJoin" targetRef="confirmPurchaingSettlement"/>

        <userTask id="confirmPurchaingSettlement" name="确认采购结算">
            <documentation>
                您需要确认采购结算。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_COMMERCE</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow560" sourceRef="confirmPurchaingSettlement" targetRef="settlementJoin"/>

        <parallelGateway id="settlementJoin" name="结算合并"/>
        <sequenceFlow id="flow570" sourceRef="settlementJoin" targetRef="comfirmData"/>

        <userTask id="comfirmData" name="确认修正数据">
            <documentation>
                您需要确认修正数据。
            </documentation>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>ROLE_COMMERCE</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>
        <sequenceFlow id="flow580" sourceRef="comfirmData" targetRef="theEnd1"/>

        <endEvent id="theEnd1"/>

    </process>

</definitions>