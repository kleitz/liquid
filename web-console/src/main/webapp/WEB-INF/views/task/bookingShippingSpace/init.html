<!DOCTYPE html>
<html>

<head th:replace="layout :: head" />

<body>
<!-- {!begin layout} -->
<div th:include="layout :: header"></div>
<!-- {!end layout} -->

<!-- {!begin task bar} -->
<div th:include="layout :: task-bar"/>
<!-- {!end task bar} -->

<div id="t" class="container" th:if="${task.assignee}">
  <div th:include="layout :: alert"/>
  
  <form method="POST" th:object="${booking}" th:action="'/task/' + ${task.Id}">
        
    <table id="booking" class="table table-striped table-hover table-condensed table-16">
      <thead>
        <tr>
          <th></th>
          <!--
          <th th:text="#{destination}">Destination</th>
          -->
          <th th:text="#{container.quantity}">Container Quantity</th>
          <th th:text="#{shipowner}">Shiponwer</th>
          <th th:text="#{booking.no}">Booking No.</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="bookingItem, rowStat : *{bookingItems}">
          <td>
            <input type="hidden" th:field="*{bookingItems[__${rowStat.index}__].id}" />
            <input type="hidden" th:field="*{bookingItems[__${rowStat.index}__].legId}" />
          </td>
          <!--
          <td th:text="*{bookingItems[__${rowStat.index}__].source} + '-' + *{bookingItems[__${rowStat.index}__].destination}" />
          -->
          <td id="containerQuantity" th:text="*{bookingItems[__${rowStat.index}__].containerQuantity}" />
          <td>
            <select th:field="*{bookingItems[__${rowStat.index}__].shipownerId}" class="form-control input-sm">
              <option th:each="shipowner : ${shipowners}"
                      th:value="${shipowner.id}"
                      th:text="${shipowner.name}">Shipowner Name
              </option>
            </select>                    
          </td>
          <td>
            <input type="text" th:field="*{bookingItems[__${rowStat.index}__].bookingNo}" class="form-control input-sm"/>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="row">
      <div class="col-xs-3 pull-right">
        <input type="hidden" id="definitionKey" name="definitionKey" th:value="${task.definitionKey}"/>
        <input type="submit" name="save" value="Save" class="btn btn-success btn-block btn-sm" th:value="#{save}"/>
      </div>
    </div>           
  </form>    
</div><!-- /.container -->

<br />

<div class="container" th:if="${task.assignee}">
  <table class="table table-striped table-hover table-condensed table-16">
    <thead>
      <tr>
        <th th:text="#{trans.mode}">Trans Mode</th>
        <th th:text="#{service.item}">Type</th>
        <th th:text="#{sp.name}">SP Name</th>
        <th th:text="#{charge.way}">Way</th>
        <th th:text="#{unit.price}">Unit Price</th>
        <th th:text="#{charge.total.price}">Total Price</th>                    
        <th th:text="#{comment}">Comment</th>
        <th>
          <a data-toggle="modal" data-target="#addPurchase" href="#">
            <span class="glyphicon glyphicon-plus text-success" />
          </a>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr th:each="purchase : ${purchases}">
        <td><span th:text="#{${transModes[purchase.transportMode]}}"></span></td>
        <td th:text="${purchase.serviceSubtype.name}">Trans Mode</td>
        <td th:text="${purchase.sp.name}">SP Name</td>
        <td th:text="#{${chargeWays[__${purchase.chargeType}__].i18nKey}}">Way</td>
        <td th:text="${purchase.unitPrice}">Unit Price</td>
        <td th:text="${purchase.totalAmount}">Total Price</td>
        <td><span th:text="${purchase.comment}"></span></td>
        <td>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="modal" id="addPurchase" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="overflow-y: hidden;" data-backdrop="static">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel"><span th:text="#{purchase}">Add Purchase</span></h4>
        </div>
        <div class="modal-body">
          <form id="purchaseForm" method="POST" th:action="'/purchase'"
            th:object="${purchase}">
            <input type="hidden" th:field="*{order}" />
            <input type="hidden" th:field="*{taskId}" />

            <div class="form-group form-group-sm">
              <label for="transportMode"  class="control-label" th:text="#{trans.mode}">Transport Mode</label>
              <select th:field="*{transportMode}" class="form-control input-sm">
                <option th:each="option : ${transportModeOptions}"
                        th:value="${option.type}" th:text="#{${option.i18nKey}}">Transport Mode
                </option>
              </select>
            </div>

            <div class="form-group form-group-sm">
              <label for="serviceSubtype" class="control-label" th:text="#{charge.type}">Charge Type</label>
              <select th:field="*{serviceSubtype}" class="form-control input-sm">
                <option th:each="serviceSubtype : ${serviceSubtypes}"
                        th:value="${serviceSubtype.id}"
                        th:text="${serviceSubtype.name}">Service Subtype
                </option>
              </select>
            </div>

            <div class="form-group form-group-sm">
              <label for="sp" class="control-label" th:text="#{sp}">SP</label>
              <select th:field="*{sp}" class="form-control input-sm">
                <option th:each="sp : ${sps}"
                        th:value="${sp.id}"
                        th:text="${sp.name}">SP Name
                </option>
              </select>
            </div>

            <div class="form-group form-group-sm">
              <label for="chargeType" class="control-label" th:text="#{charge.way}">Charge Type</label>
              <select th:field="*{chargeType}" class="form-control input-sm">
                <option th:each="chargeWay : ${chargeWays}"
                        th:value="${chargeWay.value}"
                        th:text="#{${chargeWay.i18nKey}}">
                    Charge Way
                </option>
              </select>
            </div>

            <div class="form-group form-group-sm">
              <label for="currency" class="control-label" th:text="#{currency}">Currency</label>
              <select th:field="*{currency}" class="form-control input-sm">
                  <option value="CNY">CNY</option>
                  <option value="USD">USD</option>
              </select>
            </div>

            <div class="form-group form-group-sm">
              <label for="unitPrice" class="control-label">
                <span th:text="#{unit.price}">Unit Price</span>
                <span>*</span>
              </label>
              <input type="text" th:field="*{unitPrice}" class="form-control input-sm"/>
            </div>

            <div class="form-group form-group-sm">
              <label for="totalAmount" class="control-label" th:text="#{total}">Total Amount</label>
              <input type="text" id="totalAmount" name="totalAmount" class="form-control" readonly="readonly" />
            </div>

            <div class="form-group form-group-sm">
              <label for="comment" class="control-label" th:text="#{comment}">Comment</label>
              <input type="text" id="comment" name="comment" class="form-control" />
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">
            <span th:text="#{modal.close}"/>
          </button>
          <button type="submit" name="add" value="add" form="purchaseForm" class="btn btn-warning btn-sm">
            <span th:text="#{charge.add}">Add</span>
          </button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
</div><!-- /.container -->

<!-- {!begin layout} -->
<div th:include="layout :: footer"></div>
<!-- {!end layout} -->

<!-- {!begin layout} -->
<div th:replace="layout :: js" />
<!-- {!end layout} -->

<script th:inline="javascript">
/*<![CDATA[*/
  var serviceSubtypes = /*[[${serviceSubtypes}]]*/[];
  var serviceProviders = /*[[${sps}]]*/[];
/*]]>*/
</script>

<script>
/*<![CDATA[*/
  $(document).ready(function() {

    function caculateTotal() {
      var totalAmount = 0;
      var containerQuantity = $('#containerQuantity').text();
      var unitPrice = $('#unitPrice').val();
      var chargeType = $('#chargeType').val();
      console.log('totalAmount: %f; containerQuantity: %d; unitPrice: %f; chargeType: %d.', totalAmount, containerQuantity, unitPrice, chargeType);

      if(chargeType == 1) {
        totalAmount = unitPrice * containerQuantity;
      } else {
        totalAmount = unitPrice;
      } 

      $('#totalAmount').val(totalAmount);
    }

    $('#unitPrice').change(caculateTotal);
    $('#chargeType').change(caculateTotal);

    $('#purchaseForm').validate({
      rules: {
        'unitPrice': {
          required: true,
          number: true
        },
      },
      highlight: function(element) {
          $(element).parent().addClass('has-error');
      },
      unhighlight: function(element) {
          $(element).parent().removeClass('has-error');
      },
      submitHandler: function(form) {
          form.submit();
      }
    });
    
    function computeProvider() {
      var filteredProviders = [];
      var serviceSubtypeId = $('#serviceSubtype option:selected').val();
      for(var i = 0; i < serviceProviders.length; i++) {
        for(var j = 0; j < serviceProviders[i].subtypes.length; j++) {
          if(serviceSubtypeId == serviceProviders[i].subtypes[j].id) {
            filteredProviders.push(serviceProviders[i]);
            break;
          }
        } 
      }
      $('#sp').empty();
      for(var i = 0; i < filteredProviders.length; i++) {
        $('#sp').append($('<option></option>').attr('value', filteredProviders[i].id).text(filteredProviders[i].name));
      }
    }
    computeProvider();
    $('#serviceSubtype').change(computeProvider);
  });
/*]]>*/
</script>

</body>

</html>
